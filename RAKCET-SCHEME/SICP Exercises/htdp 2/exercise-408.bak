;; The first three lines of this file were inserted by DrRacket. They record metadata
;; about the language level of this file in a form that our tools can easily process.
#reader(lib "htdp-intermediate-lambda-reader.ss" "lang")((modname exercise-408) (read-case-sensitive #t) (teachpacks ((lib "convert.rkt" "teachpack" "htdp") (lib "image.rkt" "teachpack" "2htdp") (lib "universe.rkt" "teachpack" "2htdp") (lib "batch-io.rkt" "teachpack" "2htdp") (lib "web-io.rkt" "teachpack" "2htdp") (lib "abstraction.rkt" "teachpack" "2htdp") (lib "dir.rkt" "teachpack" "htdp"))) (htdp-settings #(#t constructor repeating-decimal #f #t none #f ((lib "convert.rkt" "teachpack" "htdp") (lib "image.rkt" "teachpack" "2htdp") (lib "universe.rkt" "teachpack" "2htdp") (lib "batch-io.rkt" "teachpack" "2htdp") (lib "web-io.rkt" "teachpack" "2htdp") (lib "abstraction.rkt" "teachpack" "2htdp") (lib "dir.rkt" "teachpack" "htdp")) #f)))
(define-struct db [schema content])
; A DB is a structure: (make-db Schema Content)
 
; A Schema is a [List-of Spec]

(define-struct spec [label predicate])
; Spec is a structure: (make-spec Label Predicate)
; A Label is a String
; A Predicate is a [Any -> Boolean]
 
; A (piece of) Content is a [List-of Row]
; A Row is a [List-of Cell]
; A Cell is Any
; constraint cells do not contain functions 
 
; integrity constraint In (make-db sch con), 
; for every row in con,
; (I1) its length is the same as sch's, and
; (I2) its ith Cell satisfies the ith Predicate in sch

(define school-schema (list (make-spec "Name" string?)
                            (make-spec "Age" number?)
                            (make-spec "Present" boolean?)
                            ))


(define school-content (list (list "Alice" 35 #t)
                             (list "Bob" 25 #f)
                             (list "Carol" 30 #t)
                             (list "Dave" 32 #f)) )

(define school-db (make-db school-schema school-content))

(define presence-schema (list (make-spec "Present" boolean?)
                              (make-spec "Description" string?)
                              ))

(define presence-content (list (list #t "presence")
                               (list #f "absence")))

(define presence-db (make-db presence-schema
                             presence-content))


;[X Y -> Boolean] List-of-X List-of-Y -> Boolean
(define (andmap2 f l1 l2)
  (cond [(and (empty? l1) (empty? l2)) #t]
        [(or (empty? l1) (empty? l2)) #f]
        [(f (first l1) (first l2)) (andmap2 f (rest l1) (rest l2)) ]
        [else #f])
  )

;Exercise 405. Design the function row-filter.
; Row [List-of Label] -> Row (List-of-cells)
; retains those cells whose corresponding element in names is also in labels
(define (project.v1 db labels)
  (local ((define schema  (db-schema db))
          (define content (db-content db))
          (define schema-labels (map spec-label schema))
 
          ; Spec -> Boolean
          ; does this column belong to the new schema
          (define (keep? spec)
            (member? (spec-label spec) labels))

 
          ; Row -> Row
          ; retains those columns whose name is in labels
          (define (row-project row)
            (row-filter row schema-labels))
 
          ; Row [List-of Label] -> Row
          ; retains those cells whose name is in labels
          (define (row-filter row names)
            (foldr (lambda (name cell acc) (if (member? name labels)
                                               (cons cell acc)
                                               acc )) '() names row)
            
            #| 
            (cond
              [(empty? names) '()]
              [else 
               (if (member? (first names) labels)
                   (cons (first row)
                     (row-filter (rest row) (rest names)))
                   (row-filter (rest row) (rest names)))])
            |#
            
            ))
    (make-db (filter keep? schema)
             (map row-project content))))
(project.v1 school-db (list "Name" "Present"))


;(row-filter (first school-content) (list "Name" "Present"))
